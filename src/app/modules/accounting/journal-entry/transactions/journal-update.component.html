<div class="flex flex-col w-full filter-article filter-interactive text-gray-700">
    <div class="flex flex-col m-2">
        @if (journal_id > 0 ) {
        <div class="text-3xl gap-2 m-1 text-gray-100 p-2 bg-slate-600">
            Transaction : {{ journal_id }}
        </div>
        }
        @else
        {
            <div class="text-3xl gap-2 m-1 text-gray-100 p-2 bg-slate-600">
                Transaction 
            </div>
        }
        
        <form [formGroup]="journalForm">
            <section class="flex flex-col md:flex-row">
                <div class="flex flex-col grow">
                    <mat-form-field class="mt-1 mr-1 flex-start">
                        <input matInput placeholder="Journal Description" formControlName="description" />
                        <mat-icon class="icon-size-5" matPrefix
                        [svgIcon]="'heroicons_solid:document'"></mat-icon>
                    </mat-form-field>
                </div>
                <div class="flex flex-col w-[150px]">
                    <mat-form-field class="mt-1 flex-start mr-1">
                        <input type="text" mask="separator.2" [leadZero]="true" thousandSeparator="," class="text-right"
                            matInput placeholder="Amount" formControlName="amount"
                            [placeholder]="'Transaction Total'" />
                            <mat-icon class="icon-size-5" matPrefix
                                    [svgIcon]="'heroicons_solid:currency-dollar'"></mat-icon>
                    </mat-form-field>
                </div>
                <div class="flex flex-col w-[150px]">
                    <mat-form-field class="mt-1 flex-start mr-1">
                        <input matInput formControlName="transaction_date" [matDatepicker]="picker" />
                        <mat-datepicker-toggle matIconPrefix [for]="picker"></mat-datepicker-toggle>
                        <mat-datepicker #picker></mat-datepicker>
                    </mat-form-field>
                </div>
            </section>
        </form>
        <div mat-dialog-actions class="gap-2 mb-3">
            @if (bDirty === true) {
                <button mat-icon-button color="primary" class="bg-gray-300  stroke-purple-600 text-gray-900 hover:bg-slate-400 hover:text-gray-100 ml-1"
                (click)="onUpdateJournalEntry()" matTooltip="Update Transaction" aria-label="hover over">
                <mat-icon [svgIcon]="'feather:refresh-cw'"></mat-icon>
            </button>
            }
    
            <button mat-icon-button color="primary" class="bg-slate-200 fill-current hover:fill-white-100 text-gray-100 hover:bg-slate-400 ml-1 focus:ngring-violet-800"
                (click)="onAddLineJournalDetail()" matTooltip="Add Line" aria-label="hovered over">
                <mat-icon class="hover:bg-pink-300 fill-current " [svgIcon]="'feather:file-plus'"></mat-icon>
            </button>
    
            <button mat-icon-button color="primary" class="bg-slate-200 text-gray-100 hover:bg-slate-400 ml-1"
                (click)="onDelete()" matTooltip="Remove Line" aria-label="hovered over">
                <mat-icon [svgIcon]="'feather:trash'"></mat-icon>
            </button>
    
            <button mat-icon-button color="primary" class="bg-gray-200 hover:bg-slate-400 ml-1" 
                (click)="onAddEvidence()"
                matTooltip="Add Evidence" aria-label="Evidence">
                <mat-icon [svgIcon]="'feather:image'"></mat-icon>
            </button>
    
            <button mat-icon-button color="primary" class="bg-gray-200 hover:bg-slate-400 ml-1" 
                (click)="onCreateTemplate()"
                matTooltip="Create Template" aria-label="Template">
                <mat-icon [svgIcon]="'feather:layout'"></mat-icon>
            </button>
    
            @if (bNewTransaction === true) {
            <button mat-icon-button color="warn" class="bg-gray-200 fill-slate-100 text-white hover:bg-slate-400 ml-1" 
                (click)="closeDrawer()"
                matTooltip="Cancel" aria-label="hovered over">
                <mat-icon [svgIcon]="'mat_outline:close'"></mat-icon>
            </button>
            }
        </div>

        <form [formGroup]="journalDetailForm">
            <div class="flex flex-col">
                <dx-context-menu [dataSource]="items" [width]="200" target="#journal_subid"
                    (onItemClick)="itemClick($event)">
                </dx-context-menu>

                <div class="text-3xl m-1 text-gray-100 p-2 bg-slate-600">Details</div>
                <div class="flex flex-col h-full ml-1 mr-1 text-gray-800">
                    @if ( loading === false) {
                    @if (detailsListSignal() !== null) {
                    @if (funds$ | async; as funds) {
                    @if (subtype$ | async; as subtypes) {
                    @if
                    (filteredAccounts | async; as accounts ) {
                    <dx-data-grid id="journal_subid" [columnHidingEnabled]="true" [wordWrapEnabled]="false"
                        [dataSource]="detailsListSignal()" [showColumnLines]="true" [showRowLines]="true"
                        [showBorders]="true" [focusedRowEnabled]="true"
                        (onSelectionChanged)="onSelectionChanged($event)" 
                        (onEditingStart)="onEditingStart($event)"
                        (onSaved)="onSaved($event)"                         
                        (onContextMenuPreparing)="addMenuItems($event)"
                        (onEditCanceling)="onEditCanceling($event)" 
                        keyExpr="journal_subid"
                        (onFocusedRowChanged)="onFocusedDetailRowChanged($event)" 
                        [repaintChangesOnly]="true">
                        <dxo-editing mode="cell" [allowUpdating]="true" [allowAdding]="false" [allowDeleting]="false">
                        </dxo-editing>

                        <dxo-row-dragging [allowReordering]="true" [onReorder]="onReorder" [showDragIcons]="true"
                            dropFeedbackMode="push">
                        </dxo-row-dragging>

                        <dxo-sorting mode="none"></dxo-sorting>
                        <dxo-scrolling mode="virtual"></dxo-scrolling>
                        <dxo-selection mode="multiple"></dxo-selection>

                        <!-- <dxo-selection mode="multiple"></dxo-selection> -->
                        <!-- <dxi-column dataField="journal_subid" allowEditing=false caption="ID" width="50"> </dxi-column> -->
                        <dxi-column dataField="child" caption="Account" width="250">
                            <dxo-lookup [dataSource]="accountList" displayExpr="description" valueExpr="child">
                            </dxo-lookup>
                        </dxi-column>

                        <dxi-column dataField="fund" caption="Fund" width="100">
                            <dxo-lookup [dataSource]="funds" displayExpr="fund" valueExpr="fund">
                            </dxo-lookup>
                        </dxi-column>

                        <dxi-column dataField="sub_type" caption="Sub Type" width="150">
                            <dxo-lookup [dataSource]="subtypes" displayExpr="subtype" valueExpr="subtype">
                            </dxo-lookup>
                        </dxi-column>

                        <dxi-column dataField="description"> </dxi-column>
                        <dxi-column dataField="reference" width="150"> </dxi-column>
                        <dxi-column dataField="debit" dataType="number" width="120" alignment="right"
                            [customizeText]="formatNumber">
                        </dxi-column>
                        <dxi-column dataField="credit" dataType="number" alignment="right"
                            [customizeText]="formatNumber" width="120">
                        </dxi-column>

                        <dxo-summary>
                            <dxi-total-item column="child" summaryType="count">
                            </dxi-total-item>
                            <dxi-total-item column="debit" summaryType="sum" [valueFormat]="{
                            type: 'currency',
                            precision: 2,
                            useCurrencyAccountingStyle: true
                            }" displayFormat="{0}"></dxi-total-item>
                                        <dxi-total-item column="credit" summaryType="sum" [valueFormat]="{
                            type: 'currency',
                            precision: 2,
                            useCurrencyAccountingStyle: true
                            }" displayFormat="{0}">
                            </dxi-total-item>
                        </dxo-summary>
                    </dx-data-grid>
                    } } } } } @else {
                    <div class="flex justify-center">
                        <div>
                            <mat-progress-spinner diameter="60" [value]="value" mode="indeterminate">
                            </mat-progress-spinner>
                        </div>
                    </div>
                    }
                </div>
            </div>
        </form>
    </div>

    
</div>

