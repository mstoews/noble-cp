<div class="flex flex-col flex-auto min-w-0">
    <div class="md:max-w-7xl max-w-4xl">
        <form class="p-4 bg-card shadow rounded overflow-hidden" [formGroup]="journalEntryForm">
            <mat-vertical-stepper [linear]="true" #verticalStepper>
                <mat-step [formGroupName]="'step1'" [stepControl]="journalEntryForm.get('step1')" #verticalStepperStep1>
                    <ng-template matStepLabel>Transaction Template</ng-template>
                    <section class="flex flex-col md:flex-row gap-2">
                        <div class="flex flex-col w-[300px] gap-2">
                            @if (templateFilter | async; as templates ) {
                                <mat-form-field>
                                    <mat-label class="text-md ml-2">Template</mat-label>
                                    <mat-select [formControl]="templateCtrl" placeholder="Journal Template"  #singleTemplateSelect required>
                                        <mat-option>
                                            <ngx-mat-select-search [formControl]="templateFilterCtrl"
                                                [noEntriesFoundLabel]="'No entries found'"
                                                [placeholderLabel]="'Search'">
                                            </ngx-mat-select-search>
                                        </mat-option>
                                        @for (template of templates; track template) {
                                        <mat-option [value]="template">{{template.description}}</mat-option>
                                        }
                                    </mat-select>
                                    <mat-icon class="icon-size-5" matPrefix [svgIcon]="'heroicons_solid:document-chart-bar'"></mat-icon> 
                                </mat-form-field>
                            }
                            
                        </div>
                        <mat-form-field class="flex-auto ">
                            <mat-label class="text-md ml-2">Description</mat-label>
                            <input matInput [formControlName]="'description'" [placeholder]="'Description'" required>
                            <mat-icon class="icon-size-5" matPrefix [svgIcon]="'heroicons_solid:document'"></mat-icon>
                        </mat-form-field>
                        
                    </section>
                    
                    <section class="flex flex-col md:flex-row gap-2">    

                        <div class="flex flex-col w-[300px] gap-2">
                        @if (partyFilter | async; as parties ) {
                            <mat-form-field>
                                <mat-label class="text-md ml-2">Party</mat-label>
                                <mat-select [formControl]="partyCtrl" placeholder="Party" #singlePartySelect required>
                                    <mat-option>
                                        <ngx-mat-select-search [formControl]="partyFilterCtrl"
                                            [noEntriesFoundLabel]="'No entries found'"
                                            [placeholderLabel]="'Search'">
                                        </ngx-mat-select-search>
                                    </mat-option>
                                    @for (party of parties; track party) {
                                    <mat-option [value]="party">{{party.party_id}}</mat-option>
                                    }
                                </mat-select>
                                <mat-icon class="icon-size-5" matPrefix [svgIcon]="'heroicons_solid:currency-dollar'"></mat-icon>
                            </mat-form-field>
                        }
                        </div>


                        <mat-form-field class="flex-auto  grow">
                            <mat-label class="text-md ml-2">Reference Number</mat-label>
                            <input type="text"  class="text-right" matInput placeholder="Invoice No" formControlName="invoice_no" />
                            <mat-icon class="icon-size-5" matPrefix [svgIcon]="'heroicons_solid:currency-dollar'"></mat-icon>
                        </mat-form-field>
                        


                        <mat-form-field class="flex-auto  grow">
                            <mat-label class="text-md ml-2">Transaction Amount</mat-label>
                            <input type="text" mask="separator.2" [leadZero]="true" thousandSeparator=","
                                class="text-right" matInput placeholder="Amount" formControlName="amount"
                                [placeholder]="'Transaction Total'" />
                            <mat-icon class="icon-size-5" matPrefix
                                [svgIcon]="'heroicons_solid:currency-dollar'"></mat-icon>
                        </mat-form-field>


                        <mat-form-field class="flex-auto  grow">
                            <mat-label class="text-md ml-2">Transaction Date</mat-label>
                            <input matInput formControlName="transaction_date" [matDatepicker]="picker"
                                [placeholder]="'Transaction Date'">
                            <mat-datepicker-toggle matIconPrefix [for]="picker"></mat-datepicker-toggle>
                            <mat-datepicker #picker></mat-datepicker>
                        </mat-form-field>


                    </section>

                    <div class="flex justify-end">
                        <button class="px-8" mat-icon-button color="primary"
                            class="bg-gray-200  hover:bg-slate-400 ml-1" (click)="onUpdateHeader()"
                            [disabled]="verticalStepperStep1.stepControl.pristine || verticalStepperStep1.stepControl.invalid"
                            type="button" matTooltip="Next" matStepperNext>
                            <mat-icon [svgIcon]="'feather:arrow-right'"></mat-icon>
                        </button>
                    </div>
                    </mat-step>

                <mat-step [formGroupName]="'step2'" [stepControl]="journalEntryForm.get('step2')" #verticalStepperStep3>
                    <ng-template matStepLabel>Transaction Details</ng-template>
                    @defer () {
                        <div class="flex flex-col">
                            <div class="text-3xl m-1 text-gray-100 p-2 bg-slate-600 rounded-md">Details</div>
                            <div class="flex flex-col h-full ml-1 mr-1 text-gray-800">

                                <ejs-grid id="grid" #grid [dataSource]='store.details()'
                                    [selectionSettings]="selectionOptions" [editSettings]='editSettings'
                                    [allowFiltering]='false' [allowRowDragAndDrop]='true'
                                    (actionBegin)="actionBegin($event)" [gridLines]="'Both'"
                                    (rowDrop)="rowDrop($event)" (rowDrag)="rowDrag($event)">

                                    <e-columns>
                                        <e-column field='journal_subid' headerText='ID' [visible]='false'
                                            isPrimaryKey='true' width='100'></e-column>
                                        <e-column field='child' headerText='Account' width='100'></e-column>
                                        <e-column field='child_desc' headerText='Account Description'
                                            width='200'></e-column>
                                        <e-column field='description' headerText='Journal Description'
                                            width='150'></e-column>
                                        <e-column field='fund' headerText='Fund' width='90'></e-column>
                                        <e-column field='sub_type' headerText='Sub Type' width='90'></e-column>
                                        <e-column field='reference' headerText='Reference' width=120></e-column>
                                        <e-column field='debit' headerText='Debit' textAlign='Right' width='100'
                                            format="N2"></e-column>
                                        <e-column field='credit' headerText='Credit' textAlign='Right' width='100'
                                            format="N2"></e-column>
                                    </e-columns>

                                    <e-aggregates>
                                        <e-aggregate>
                                            <e-columns>
                                                <e-column type="Sum" field="debit" format="N2">
                                                    <ng-template #footerTemplate let-data>{{data.Sum}}</ng-template>
                                                </e-column>
                                                <e-column type="Sum" field="credit" format="N2">
                                                    <ng-template #footerTemplate let-data>{{data.Sum}}</ng-template>
                                                </e-column>
                                            </e-columns>
                                        </e-aggregate>
                                    </e-aggregates>
                                </ejs-grid>
                            </div>
                        </div>
                    }
                <div class="flex justify-end mt-2">
                <button mat-icon-button color="primary" class="bg-gray-200  hover:bg-slate-400 ml-1"
                    type="button" matTooltip="Back" aria-label="Template" matStepperPrevious>
                    <mat-icon [svgIcon]="'feather:arrow-left'"></mat-icon>
                </button>

                <button mat-icon-button color="primary" class="bg-gray-200  hover:bg-slate-400 ml-1"
                    type="button" matTooltip="Post Transaction" aria-label="Template"
                    [disabled]="verticalStepperStep3.stepControl.pristine || verticalStepperStep3.stepControl.invalid"
                    (click)="onUpdate()" matStepperNext>
                    <mat-icon [svgIcon]="'feather:arrow-right'"></mat-icon>
                </button>
                </div>  

                    <!-- <section class="flex flex-row mt-2 gap-2">

                        <div class="flex flex-col md:flex-row grow">
                            <mat-form-field class="flex-col grow ">
                                <input matInput placeholder="Description" formControlName="detail_description"
                                    [placeholder]="'Line Description'" />
                                <mat-icon class="icon-size-5" matPrefix
                                    [svgIcon]="'heroicons_solid:calculator'"></mat-icon>
                            </mat-form-field>
                        </div>

                        <div class="flex flex-col md:flex-row grow">
                            <mat-form-field class="flex-col grow ">
                                <input matInput placeholder="Reference" formControlName="reference"
                                    [placeholder]="'Reference'" />
                                <mat-icon class="icon-size-5" matPrefix
                                    [svgIcon]="'heroicons_solid:document'"></mat-icon>
                            </mat-form-field>
                        </div>
                    </section>
                    <section class="flex flex-row gap-2">
                        @if (subtype$ | async; as subtypes) {
                        <div class="flex flex-col md:flex-row grow">
                            <mat-form-field class="flex-col grow ">
                                <mat-select class="text-gray-800" placeholder="Sub Type" formControlName="sub_type"
                                    (selectionChange)="changeSubtype($event)">
                                    @for (item of subtypes; track item)
                                    { <mat-option [value]="item.subtype"> {{ item.subtype }} </mat-option>
                                    }
                                </mat-select>
                                <mat-icon class="icon-size-5" matPrefix [svgIcon]="'feather:pen-tool'"></mat-icon>
                            </mat-form-field>
                        </div>
                        }

                        @if (funds$ | async; as funds) {
                        <div class="flex flex-col md:flex-row grow">
                            <mat-form-field class="flex-col grow">
                                <mat-select class="text-gray-800" placeholder="Fund" formControlName="fund"
                                    (selectionChange)="changeFund($event)">
                                    @for (item of funds; track item)
                                    { <mat-option [value]="item.fund"> {{ item.fund }} - {{item.description}}
                                    </mat-option>
                                    }
                                </mat-select>
                                <mat-icon class="icon-size-5" matPrefix
                                    [svgIcon]="'heroicons_solid:briefcase'"></mat-icon>
                            </mat-form-field>
                        </div>
                        }
                    </section>
                    <section class="flex flex-row gap-2">
                        <div class="flex flex-col grow">
                            @if (filteredDebitAccounts | async; as accounts ) {
                            <mat-form-field>
                                <mat-select [formControl]="debitCtrl" placeholder="Debit Account" #singleDebitSelect>
                                    <mat-option>
                                        <ngx-mat-select-search [formControl]="debitAccountFilterCtrl"
                                            [noEntriesFoundLabel]="'No entries found'"
                                            [placeholderLabel]="'Search'"></ngx-mat-select-search>
                                    </mat-option>
                                    @for (account of accounts; track account) {
                                    <mat-option [value]="account">{{account.description}}</mat-option>
                                    }
                                </mat-select>
                                <mat-icon class="icon-size-5" matPrefix
                                    [svgIcon]="'heroicons_solid:currency-dollar'"></mat-icon>
                            </mat-form-field>
                            }
                        </div>
                        <div class="flex flex-col w-[200px]">
                            <mat-form-field class="form-element">
                                <input type="text" mask="separator.2" [leadZero]="true" thousandSeparator=","
                                    class="text-right" matInput [placeholder]="'Debit Amount'"
                                    formControlName="debit" />
                                <mat-icon class="icon-size-5" matPrefix
                                    [svgIcon]="'heroicons_solid:currency-dollar'"></mat-icon>
                            </mat-form-field>
                        </div>


                        <div class="flex flex-col grow">
                            @if (filteredCreditAccounts | async; as accounts ) {
                            <mat-form-field>
                                <mat-select [formControl]="creditCtrl" placeholder="Credit Account" #singleCreditSelect>
                                    <mat-option>
                                        <ngx-mat-select-search [formControl]="creditAccountFilterCtrl"
                                            [noEntriesFoundLabel]="'No entries found'"
                                            [placeholderLabel]="'Search'"></ngx-mat-select-search>
                                    </mat-option>
                                    @for (account of accounts; track account) {
                                    <mat-option [value]="account">{{account.description}}</mat-option>
                                    }
                                </mat-select>
                                <mat-icon class="icon-size-5" matPrefix
                                    [svgIcon]="'heroicons_solid:currency-dollar'"></mat-icon>
                            </mat-form-field>
                            }
                        </div>
                        <div class="flex flex-col w-[200px]">
                            <mat-form-field class="form-element">
                                <input type="text" mask="separator.2" [leadZero]="true" thousandSeparator=","
                                    class="text-right" matInput [placeholder]="'Credit Amount'"
                                    formControlName="credit" />
                                <mat-icon class="icon-size-5" matPrefix
                                    [svgIcon]="'heroicons_solid:currency-dollar'"></mat-icon>
                            </mat-form-field>
                        </div>
                    </section>
                    <div class="flex justify-end">

                        <button mat-icon-button color="primary" class="bg-gray-200  hover:bg-slate-400 ml-1"
                            type="button" matTooltip="Back" aria-label="Template" matStepperPrevious>
                            <mat-icon [svgIcon]="'feather:arrow-left'"></mat-icon>
                        </button>

                        <button mat-icon-button color="primary" class="bg-gray-200  hover:bg-slate-400 ml-1"
                            type="button" matTooltip="Post Transaction" aria-label="Template"
                            [disabled]="verticalStepperStep3.stepControl.pristine || verticalStepperStep3.stepControl.invalid"
                            (click)="onUpdate()" matStepperNext>
                            <mat-icon [svgIcon]="'feather:arrow-right'"></mat-icon>
                        </button>

                    </div> -->

                </mat-step>

                <mat-step [formGroupName]="'step3'" [stepControl]="journalEntryForm.get('step3')" #verticalStepperStep4>
                    <ng-template matStepLabel>Post/Edit Transaction</ng-template>
                    @if (journalHeader) {
                    <div class="text-gray-800 text-3xl m-1">Confirm Transaction</div>
                    <div class="flex">
                        <div class="text-gray-600 m-1">Description : {{journalHeader.description}}</div>
                    </div>
                    <div class="flex">
                        <div class="text-gray-600 m-1">Transaction Date : {{journalHeader.transaction_date}}</div>
                    </div>
                    <div class="flex">
                        <div class="text-gray-600 m-1">Amount : {{journalHeader.amount | number: '1.2-2' }}</div>
                    </div>

                    }
                    <ng-container>
                        <wizard-update [journal_id]="journal_id" [sTitle]="'Journal Entry Detail'"
                            [description]="description" [amount]="headerAmount">
                        </wizard-update>

                    </ng-container>
                    <div class="flex justify-end mt-8">
                        <button mat-icon-button color="primary" class="bg-gray-200  hover:bg-slate-400 ml-1"
                            type="button" matTooltip="Back to Entry" aria-label="Template" matStepperPrevious>
                            <mat-icon [svgIcon]="'feather:arrow-left'"></mat-icon>
                        </button>

                        <button mat-icon-button color="primary" class="bg-gray-200  hover:bg-slate-400 ml-1"
                            type="button" matTooltip="Post Transaction" aria-label="Template" matStepperNext
                            [disabled]="verticalStepperStep3.stepControl.pristine || verticalStepperStep3.stepControl.invalid">
                            <mat-icon [svgIcon]="'feather:arrow-right'"></mat-icon>
                        </button>

                    </div>
                </mat-step>

                <mat-step>
                    <ng-template matStepLabel>Completed</ng-template>

                    <ng-container>
                        <div class="flex flex-col h-full mb-2">
                            <mat-icon class="icon-size-20 text-green-700" matPrefix
                                [svgIcon]="'feather:check'"></mat-icon>
                        </div>
                    </ng-container>
                    @if (journalHeader) {
                    <div class="text-gray-800 text-bold text-3xl m-1">Transaction Confirmed</div>
                    <div class="flex">
                        <div class="text-gray-600 m-1">Description : {{journalHeader.description}}</div>
                    </div>
                    <div class="flex">
                        <div class="text-gray-600 m-1">Transaction Date : {{journalHeader.transaction_date}}</div>
                    </div>
                    <div class="flex">
                        <div class="text-gray-600 m-1">Amount : {{journalHeader.amount | number: '1.2-2'}}</div>
                    </div>

                    <div class="flex">
                        <div class="text-gray-600 m-1">The transaction has been completed. Please add a digital artifact
                            to confirm the transation.</div>
                    </div>

                    }
                    <div class="flex justify-end mt-8">
                        <button class="px-8 mr-2" mat-flat-button [color]="'accent'" type="button"
                            (click)="onAddArtifact()">
                            Add an Artifact
                        </button>
                        <button class="px-8" mat-flat-button [color]="'primary'" type="reset"
                            (click)="verticalStepper.reset();">
                            Clear and Restart
                        </button>
                    </div>
                </mat-step>
            </mat-vertical-stepper>
        </form>
    </div>
</div>